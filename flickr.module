<?php

// $Id: flickr.module,v 1.20 2006/12/27 03:13:58 drewish Exp $

require_once(drupal_get_path('module', 'flickr') .'/flickr.inc');

/**
 * Implementation of hook_help().
 */
function flickr_help($section) {
  switch ($section) {
    case 'admin/settings/flickr':
     return t("You will need a Flickr API key to use this module. You can apply for one at <a href='%link'>%link</a>", array('%link' => url('http://www.flickr.com/services/api/keys/apply/')));
    case 'admin/help#flickr':
      return t('The flickr module uses XML-RPC to connect to Flickr\'s API and retreive photo information.');
  }
}

/**
 * Implementation of hook_menu().
 */
function flickr_menu($may_cache) {
  $items = array();

  if ($may_cache) {
    $items[] = array(
      'path' => 'admin/settings/flickr', 'title' => t('Flickr'),
      'callback' => 'drupal_get_form',
      'callback arguments' => array('flickr_admin_settings'),
      'access' => user_access('administer site configuration'),
      'type' => MENU_NORMAL_ITEM,
      'description' => t('Change settings for the flickr module.'));


    $items[] = array(
      'path' => 'flickr', 'title' => t('Flickr'),
      'access' => user_access('access content'),
      'type' => MENU_CALLBACK,
      'callback' => 'flickr_recent');

    $items[] = array(
      'path' => 'flickr/photosets', 'title' => t('Flickr photosets'),
      'access' => user_access('access content'),
      'type' => MENU_NORMAL_ITEM,
      'callback' => 'flickr_photosets',
    );


    $items[] = array(
      'path' => 'flickr/auth',
      'access' => TRUE,
      'type' => MENU_CALLBACK,
      'callback' => 'flickr_auth_callback');

  }

  return $items;
}

/**
 * Implementation of hook_settings
 */
function flickr_admin_settings() {
  $form['#validate'] = array('flickr_admin_settings_validate' => array());
  $form['flickr_api_key'] = array(
    '#type' => 'textfield',
    '#title' => t('API Key'),
    '#default_value' => variable_get('flickr_api_key', ''),
    '#description' => t('API Key from Flickr'),
  );
  $form['flickr_api_secret'] = array(
    '#type' => 'textfield',
    '#title' => t('API Shared Secret'),
    '#default_value' => variable_get('flickr_api_secret', ''),
    '#description' => t("API key's secret from Flickr."),
  );
  $form['flickr_default_userid'] = array(
    '#type' => 'textfield',
    '#title' => t('Default Flickr User Id'),
    '#default_value' => variable_get('flickr_default_userid', ''),
    '#description' => t("An, optional, default Flickr username or user id. This will be used when no user is specified."),
  );

  return system_settings_form($form);
}

function flickr_admin_settings_validate($form_id, $form) {
  $key = trim($form['flickr_api_key']);
  $sec = trim($form['flickr_api_secret']);
  $uid = trim($form['flickr_default_userid']);
  
  if ($key && (preg_match('/^[A-Fa-f\d]{32}$/', $key) != 1)) {
    form_set_error('flickr_api_key', t('This does not appear to be a Flickr API key.'));
  }
  if ($sec && (preg_match('/^[A-Fa-f\d]{16}$/', $sec) != 1)) {
    form_set_error('flickr_api_secret', t('This does not appear to be a Flickr API secret.'));
  }
  if ($uid) {
    if (preg_match('/^\d+@N\d+$/', $uid)) {
      // it's already a uid
    }
    else {
      $response = flickr_user_find_by_username($uid);
      if (!isset($response['stat']) || $response['stat'] != 'ok') {
        form_set_error('flickr_default_userid', t('This is neither a Flickr user name or id.'));
      }
    }
  }
}

function flickr_admin_settings_submit($form_id, $form) {
  // clean up the data
  $form['flickr_api_key'] = trim($form['flickr_api_key']);
  $form['flickr_api_secret'] = trim($form['flickr_api_secret']);
  // replace the username with a user id
  if (preg_match('/^\d+@N\d+$/', $uid) == 0) {
    $response = flickr_user_find_by_username($form['flickr_default_userid']);
    if (isset($response['stat']) && $response['stat'] == 'ok') {
      $form['flickr_default_userid'] = $response['user']['id'];
    }
  }
  // and save the settings
  system_settings_form_submit($form_id, $form);
}


/**
 * Implementation of hook_block().
 */
function flickr_block($op = 'list', $delta = 0, $edit = array()) {
  if ($op == 'list') {
    $blocks[0]['info'] = t('Flickr recent photos by user');
    $blocks[1]['info'] = t('Flickr photosets by user');
    $blocks[2]['info'] = t('Flickr random photos by user');
    return $blocks;
  }
  else if ($op == 'configure') {
    $form = array();

    $count_options = array(1 => '1', 2 => '2', 3 => '3',  4 => '4', 5 => '5', 6 => '6', 7 => '7',  8 => '8', 9 => '9', 10 => '10', 15 => '15', 20 => '20', 25 => '25', 30 => '30');
    // remove the large and original sizes
    $sizes = flickr_photo_sizes();
    unset($sizes['b']);
    unset($sizes['o']);
    $size_options = array();
    foreach ($sizes as $key => $size) {
      $size_options[$key] = $size['description'];
    }

    $form["flickr_block_{$delta}_user_id"] = array(
      '#type' => 'textfield',
      '#title' => t('Flickr User Id'),
      '#default_value' => variable_get("flickr_block_{$delta}_user_id", ''),
      '#description' => t("The user id of a Flickr user. If this is left blank, the sites's default user will be used."),
    );

    switch ($delta) {
    case 0:
      $form['flickr_block_0_show_n'] = array(
        '#type' => 'select',
        '#options' => $count_options,
        '#title' => t('Show the last <em>n</em> photos'),
        '#default_value' => variable_get('flickr_block_0_show_n', 5),
        '#description' => t("The block will show this many of the user's most recent photos.")
      );
      break;
    case 1:
      $form['flickr_block_1_show_n'] = array(
        '#type' => 'select',
        '#options' => $count_options,
        '#title' => t('Show the last <em>n</em> photosets'),
        '#default_value' => variable_get('flickr_block_1_show_n', 5),
        '#description' => t("The block will show this many of the user's photosets.")
      );
      break;
    case 2:
      $form['flickr_block_2_show_n'] = array(
        '#type' => 'select',
        '#options' => $count_options,
        '#title' => t('Show the last <em>n</em> photosets'),
        '#default_value' => variable_get('flickr_block_2_show_n', 5),
        '#description' => t("The block will show this many of the user's photosets.")
      );
      break;
    }
    $form["flickr_block_{$delta}_size"] = array(
      '#type' => 'select',
      '#options' => $size_options,
      '#title' => t('Size of photos'),
      '#default_value' => variable_get("flickr_block_{$delta}_size", 's'),
      '#description' => t("Select the size of photos you'd like to display in the block.")
    );
    return $form;
  }
  else if ($op == 'save') {
    switch($delta) {
      case 0:
      case 1:
      case 2:
        // replace usernames with a user id
        $user = $edit["flickr_block_{$delta}_user_id"];
        if (preg_match('/^\d+@N\d+$/', $$user) == 0) {
          $response = flickr_user_find_by_username($user);
          if (isset($response['stat']) && $response['stat'] == 'ok') {
            $user = $response['user']['id'];
          }
          else {
            $user = '';
          }
        }
        variable_set("flickr_block_{$delta}_user_id", $user);
        
        variable_set("flickr_block_{$delta}_show_n", $edit["flickr_block_{$delta}_show_n"]);
        variable_set("flickr_block_{$delta}_size", $edit["flickr_block_{$delta}_size"]);
    }
  }
  else if ($op == 'view') {
    $default_userid = variable_get('flickr_default_userid', '');
    switch ($delta) {
    case 0:
      $user_id = variable_get('flickr_block_0_user_id', $default_userid);
      $show_n = variable_get('flickr_block_0_show_n', 5);
      $size = variable_get('flickr_block_0_size', 's');
      $block['subject'] = t('Recent Flickr');
      $block['content'] = _flickr_block_recent($user_id, $show_n, $size);
      break;
    case 1:
      $user_id = variable_get('flickr_block_1_user_id', $default_userid);
      $show_n = variable_get('flickr_block_1_show_n', 5);
      $size = variable_get('flickr_block_1_size', 's');
      $block['subject'] = t('Flickr Photosets');
      $block['content'] = _flickr_block_photosets($user_id, $show_n, $size);
      break;
    case 2:
      $user_id = variable_get('flickr_block_2_user_id', $default_userid);
      $show_n = variable_get('flickr_block_2_show_n', 5);
      $size = variable_get('flickr_block_2_size', 's');
      $block['subject'] = t('Flickr Random');
      $block['content'] = _flickr_block_random($user_id, $show_n, $size);
      break;
    }

    return $block;
  }
}


function _flickr_block_recent($user_id, $show_n, $size) {
  $result = flickr_request(
    'flickr.photos.search',
    array(
      'user_id' => $user_id,
      'per_page' => $show_n,
    )
  );
  $output = '';
  foreach((array)$result['photos']['photo'] as $photo) {
    $output .= theme('flickr_photo', $photo, $size);
  }
  return $output;
}

function _flickr_block_photosets($user_id, $show_n, $size) {
  $output = '';
  $result = flickr_request('flickr.photosets.getList', array('user_id' => $user_id));
  $to = min($show_n, count($result['photosets']['photoset']));
  for ($i = 0; $i < $to; $i++) {
    $output .= theme('flickr_photoset', $result['photosets']['photoset'][$i], $user_id, $size);
  }
  return $output;
}

function _flickr_block_random($user_id, $show_n, $size) {
  $request = array(
    'user_id' => $user_id,
    'per_page' => 500,
    'page' => 1,
  );
  $result = flickr_request('flickr.photos.search', $request);
  $page_count = $result['photos']['pages'];

  // we shouldn't try to return more than the total number of photos
  $to = min($show_n, $result['photos']['total']);
  $output = '';
  for ($i = 0; $i < $to; $i++) {
    sleep(0.125);
    // request a random page
    $request['page'] = rand(1, $page_count);
    $result = flickr_request('flickr.photos.search', $request);
    // then select a random photo
    $index = rand(0, count($result['photos']['photo']));
    $output .= theme('flickr_photo', $result['photos']['photo'][$index], $size);
  }

  return $output;
}

function flickr_recent() {
  drupal_add_css(drupal_get_path('module', 'flickr') .'/flickr.css');

  $result = flickr_request(
    'flickr.photos.search',
    array(
      'user_id' => variable_get('flickr_default_userid', ''),
      'per_page' => 20,
    )
  );
  $output = "<div class='fickr-photoset'>\n";
  foreach((array)$result['photos']['photo'] as $photo) {
    $output .= theme('flickr_photo_box', $photo, 'm');
  }
  $output .= '</div>';
  return $output;
}


function flickr_photosets($flickr_userid = NULL) {
  drupal_add_css(drupal_get_path('module', 'flickr') .'/flickr.css');

  if (!isset($flickr_userid)) {
    $flickr_userid = variable_get('flickr_default_userid', '');
  }

  $output = "<div class='fickr-photosets'>\n";
  $result = flickr_request('flickr.photosets.getList', array('user_id' => $flickr_userid));
  foreach((array)$result['photosets']['photoset'] as $photoset) {
    $output .= theme('flickr_photoset_box', $photoset, $flickr_userid, 's');
  }
  $output .= '</div>';

  return $output;
}


function theme_flickr_photo($p, $size = NULL, $format = NULL) {
  $img = flickr_img($p, $size);
  $photo_url = flickr_photo_page_url($p['owner'], $p['id']);
  return l($img, $photo_url, NULL, NULL, NULL, TRUE, TRUE);
}

function theme_flickr_photo_box($p, $size = NULL, $format = NULL) {
  $img = flickr_img($p, $size);
  $title = is_array($p['title']) ? $p['title']['_content'] : $p['title'];
  $photo_url = flickr_photo_page_url($p['owner'], $p['id']);

  $output .= "<div class='flickr-photo-box'>\n";
  $output .= "<a href='$photo_url'>$img</a>";
  $output .= "<a href='$photo_url'>";
  $output .= '<div class="flickr-photo-title">'. $title ."</div>\n";
  $output .= "</a>";
  $output .= "</div>\n";

  return $output;
}

function theme_flickr_photoset($ps, $owner, $size = NULL, $format = NULL) {
  $title = is_array($ps['title']) ? $ps['title']['_content'] : $ps['title'];
  $img = flickr_img($ps, $size);
  $photo_url = flickr_photoset_page_url($owner, $ps['id']);
  return l($img, $photo_url, NULL, NULL, NULL, TRUE, TRUE);
}

function theme_flickr_photoset_box($ps, $owner, $size = NULL, $format = NULL) {
  $title = is_array($ps['title']) ? $ps['title']['_content'] : $ps['title'];
  $photo_url = flickr_photoset_page_url($owner, $ps['id']);

  $output .= "<div class='flickr-photoset-box'>\n";
  $output .= "<a href='$photo_url'>";
  $output .= flickr_img($ps, $size);
  $output .= "</a>";
  $output .= "<a href='$photo_url'>";
  $output .= '<div class="flickr-photoset-title">'. $title ."</div>\n";
  $output .= "</a>";
  $output .= '<div class="flickr-photoset-count">'. format_plural($ps['photos'], '@count photo', '@count photos') ."</div>\n";
  $output .= "</div>\n";

  return $output;
}

/**
 * Implimentation of the hook_user()
 * Add an extra field for the user to enter his flickr nsid.
 */
function flickr_user($op, &$edit, &$account, $category = NULL) {
  $data = unserialize($account->data);
  
  if ($op == 'form' && $category == 'account') {
    $form['flickr'] = array(
      '#type' => 'fieldset',
      '#title' => t('Flickr settings'),
      '#collapsible' => FALSE,
      '#weight' => 4,
    );
    $form['flickr']['nsid'] = array(
      '#type' => 'textfield',
      '#title' => t('Flickr NSID'),
      '#default_value' => $data['nsid'],
      '#description' => t('Please enter your Flickr NSID.'),
    );
    return $form;
  }
}
